@model ViewPessoaOrcamento

@{
    TempData["Title"] = "Criar orçamento";
}

@{
    Layout = "_Layout";
}

@if (TempData["MessageErro"] != null)
{
    <div class="alert alert-danger" role="alert">
        <button type="button" class="btn btn-danger btn-sm close-alert" data-bs-dismiss="alert" arial-label="Close">X</button>
        @TempData["MessageErro"]
    </div>
}

@{
    TempData["Title"] = "Incluir Orçamento";
}
<div class="main-content container-fluid">
    <div class="page-title">
        <div class="row">
            <div class="row match-height">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Novo orçamento</h4>
                        </div>
                        <div class="card-body">
                            <form asp-action="Create">
                                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                                <div class="row" id="table-hover-row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4 class="card-title">Produtos</h4>
                                            </div>
                                            <div class="form-group">
                                                <label for="codigo-produto">Código do produto</label>
                                                <input type="text" id="codigo-produto" class="form-control" />
                                            </div>
                                            <div class="form-group">
                                                <label for="nome-produto">Nome do Produto</label>
                                                <input type="text" id="nome-produto" class="form-control" />
                                            </div>
                                            <div class="col-sm mb-4">
                                                <button type="button" id="adicionar-produto" class="btn btn-primary">Adicionar Produto</button>
                                            </div>
                                            <table class="table">
                                                <thead>
                                                <tr>
                                                    <th>Código</th>
                                                    <th>Nome do Produto</th>
                                                    <th>Valor R$</th>
                                                    <th></th>
                                                </tr>
                                                </thead>
                                                <tbody id="produtos-body">
                                                <!-- Aqui será dinamicamente adicionado HTML para cada produto -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-sm-6 mb-3">
                                        <h6>Nome</h6>
                                        <div class="form-group position-relative has-icon-left">
                                            <select id="pesIdSelect" asp-for="Orcamento.PesId" required class="form-control" asp-items="ViewBag.PesId"></select>
                                            <input type="hidden" asp-for="Orcamento.PesId" id="pesIdHidden"/>
                                            <div class="form-control-icon">
                                                <i data-feather="user"></i>
                                            </div>
                                            @Html.ValidationMessageFor(model => model.Orcamento.PesId, "", new { @class = "text-danger" })
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-sm-3 mb-3">
                                        <h6>Forma de pagamento <i class="bi bi-credit-card-2-back"></i> <i class="bi bi-wallet2"></i></h6>
                                        <div class="form-group position-relative">
                                            <select class="form-select col-2" asp-for="Orcamento.OrcTipoPagamento" required aria-label="Selecione uma forma de pagamento">
                                                <option selected>Selecione</option>
                                                <option value="Dinheiro Ávista">Dinheiro</option>
                                                <option value="Dinheiro + 1x parcela - Cartão de Crédito">Dinheiro + 1x parcela - Cartão de Crédito</option>
                                                <option value="Parcelado - 1x Parcela + Cartão de crédito">1x parcela - Cartão de Crédito</option>
                                                <option value="Parcelado - 2x">2x - parcelas no Cartão de Crédito</option>
                                                <option value="Parcelado - 3x">3x - parcelas no Cartão de Crédito</option>
                                                <option value="Parcelado - 4x">4x - parcelas no Cartão de Crédito</option>
                                                <option value="Parcelado - 5x">5x - parcelas no Cartão de Crédito</option>
                                                <option value="Parcelado - 6x">6x - parcelas no Cartão de Crédito</option>
                                                <option value="Parcelado - 7x">7x - parcelas no Cartão de Crédito</option>
                                                <option value="Parcelado - 8x">8x - parcelas no Cartão de Crédito</option>
                                                <option value="Parcelado - 9x">9x - parcelas no Cartão de Crédito</option>
                                                <option value="Parcelado - 10x">10x - parcelas no Cartão de Crédito</option>
                                            </select>
                                        </div>
                                        @Html.ValidationMessageFor(model => model.Orcamento.OrcTipoPagamento, "", new { @class = "text-danger" })
                                    </div>

                                    <div class="col-sm-3 mb-3">
                                        <h6>Valor R$</h6>
                                        <div class="form-group position-relative">
                                            <input id="preco" type="text" asp-for="Orcamento.OrcPreco" class="form-control" placeholder="R$"/>
                                        </div>
                                        @Html.ValidationMessageFor(model => model.Orcamento.OrcPreco, "", new { @class = "text-danger" })
                                    </div>

                                    <div class="col-sm-2 mb-3">
                                        <h6>Forma da entrega</h6>
                                        <div class="form-group position-relative">
                                            <select class="form-select" asp-for="Orcamento.OrcTipoEntrega" required aria-label="Selecione uma de entrega">
                                                <option selected>Selecione</option>
                                                <option value="Lojá">Lojá</option>
                                                <option value="Pessoa">Cliente</option>
                                                <option value="Transportadora">Transportadora</option>
                                            </select>
                                        </div>
                                        @Html.ValidationMessageFor(model => model.Orcamento.OrcTipoEntrega, "", new { @class = "text-danger" })
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-sm-8 mb-3">
                                        <h6>Observação</h6>
                                        <div class="form-group position-relative has-icon-left">
                                            <input type="text" class="form-control" placeholder="" asp-for="Orcamento.OrcObservacao">
                                            <div class="form-control-icon">
                                                <div class="form-control-icon">
                                                    <i class="bi bi-card-text"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-sm-8 mb-3">
                                        <h6>Descrição</h6>
                                        <div class="form-group position-relative">
                                            <textarea asp-for="Orcamento.OrcDesc" class="form-control" placeholder="Descrição do produto..." style="height: 200px"></textarea>
                                            <div class="form-control-icon">
                                            </div>
                                            @Html.ValidationMessageFor(model => model.Orcamento.OrcDesc, "", new { @class = "text-danger" })
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-sm mb-4">
                                        <input type="submit" value="Incluir orçamento" class="btn btn-primary"/>
                                        <a type="button" class="btn btn-danger" asp-controller="Pessoa" asp-action="Index">Cancelar</a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
@section Scripts {
    <script>
        $(document).ready(function () {
            var produtos = []; // Array para armazenar os produtos

            $("#adicionar-produto").on("click", function () {
                var codigoProduto = $("#codigo-produto").val();
                var nomeProduto = $("#nome-produto").val();

                // Chamada Ajax para buscar detalhes do produto no backend
                $.ajax({
                    url: '@Url.Action("ObterDetalhesProduto")',
                    type: 'GET',
                    data: { codigoProduto: codigoProduto, nomeProduto: nomeProduto },
                    success: function (detalhesProduto) {
                        // Verificar se o produto foi encontrado
                        if (detalhesProduto) {
                            var produto = {
                                Codigo: detalhesProduto.codigo,
                                Nome: detalhesProduto.nome,
                                Preco: detalhesProduto.preco
                                // Preco: detalhesProduto.Preco
                            };

                            produtos.push(produto);
                            renderizarTabela();
                        } else {
                            alert("Produto não encontrado.");
                        }
                    },
                    error: function () {
                        alert("Erro ao buscar detalhes do produto.");
                    }
                });
            });

            window.removerProduto = function (rowIndex) {
                produtos.splice(rowIndex, 1);
                renderizarTabela();
            };

            function renderizarTabela() {
                // Limpar a tabela
                $("#produtos-body").empty();
                // Adicionar produtos à tabela
                for (var i = 0; i < produtos.length; i++) {
                    var newRow =
                        "<tr>" +
                        "<td>" + produtos[i].Codigo + "</td>" +
                        "<td>" + produtos[i].Nome + "</td>" +
                        "<td>" + produtos[i].Preco + "</td>" +
                        "<td><button type='button' class='btn btn-danger' onclick='removerProduto(" + i + ")'>Remover</button></td>" +
                        "</tr>";

                    $("#produtos-body").append(newRow);
                }
            }
        });
    </script>
}


@* *@
@* @section Scripts { *@
@*     <script> *@
@*         $(document).ready(function () { *@
@*             var produtos = []; // Array para armazenar os produtos *@
@* *@
@*             $("#adicionar-produto").on("click", function () { *@
@*                 var codigoProduto = $("#codigo-produto").val(); *@
@*                 var nomeProduto = $("#nome-produto").val(); *@
@* *@
@*                 // Você deve implementar a lógica para buscar o produto pelo código ou nome no seu backend. *@
@*                 // Aqui, estou apenas adicionando um objeto fictício à lista. *@
@*                 var produto = { *@
@*                     Codigo: codigoProduto, *@
@*                     Nome: nomeProduto, *@
@*                     Preco: 0 // Você deve ajustar o preço conforme a lógica real *@
@*                 }; *@
@* *@
@*                 produtos.push(produto); *@
@* *@
@*                 renderizarTabela(); *@
@*             }); *@
@* *@
@*             window.removerProduto = function (rowIndex) { *@
@*                 produtos.splice(rowIndex, 1); *@
@*                 renderizarTabela(); *@
@*             }; *@
@* *@
@*             function renderizarTabela() { *@
@*                 // Limpar a tabela *@
@*                 $("#produtos-body").empty(); *@
@* *@
@*                 // Adicionar produtos à tabela *@
@*                 for (var i = 0; i < produtos.length; i++) { *@
@*                     var newRow = *@
@*                         "<tr>" + *@
@*                         "<td>" + produtos[i].Codigo + "</td>" + *@
@*                         "<td>" + produtos[i].Nome + "</td>" + *@
@*                         "<td>" + produtos[i].Preco + "</td>" + *@
@*                         "<td><button type='button' class='btn btn-danger' onclick='removerProduto(" + i + ")'>Remover</button></td>" + *@
@*                         "</tr>"; *@
@* *@
@*                     $("#produtos-body").append(newRow); *@
@*                 } *@
@*             } *@
@*         }); *@
@*     </script> *@
@* } *@
